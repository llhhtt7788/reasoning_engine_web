# w.2.5.3 Bug Fix: 修复新建会话导致的列表混乱

**修复时间**: 2026-01-17
**版本**: w.2.5.3

---

## 🐛 问题描述

**现象**:
用户反馈新建会话时，左侧会话列表会变得混乱。

**根本原因分析**:
1. **空白会话堆积**: 每次页面刷新或点击"新建对话"时，`createNewSession` 都会立即向 `sessions` 列表中添加一个 `messageCount: 0` 的 "New Chat" 条目。
2. **持久化污染**: 这些空白会话被保存到 localStorage。
3. **刷新放大**: 用户多次刷新页面后，LocalStorage 中积累了大量空白的 "New Chat" 条目，导致列表充斥着无用数据。
4. **ID 冲突**: 虽然 ID 是随机生成的，但视觉上大量相同的 "New Chat" 让人困惑，且可能掩盖了真实会话的逻辑。

---

## ✅ 修复方案

### 1. 延迟创建会话条目

修改 `createNewSession` 方法：
- **修改前**: 立即向 `sessions` 列表添加新条目并持久化。
- **修改后**: 仅更新 `currentSessionId` 指向新 ID，**不**向列表中添加条目。
- **创建时机**: 真正的列表条目创建推迟到用户发送第一条消息时（由 `saveCurrentSession` 自动处理）。

### 2. 清理“僵尸”会话

修改 `loadSessionsFromBackend` 方法：
- 在加载 LocalStorage 数据时，增加过滤条件。
- **过滤规则**: 排除 `messageCount === 0` 且仅存在于本地的会话。
- 这样可以自动清理掉之前版本产生的“僵尸”空白会话。

---

## 🧪 验证步骤

1. **刷新页面**
   - 观察左侧列表，之前的多个 "New Chat" 空白条目应该消失。
   - 应该只保留有真实消息历史的会话。

2. **点击"新建对话"**
   - 观察左侧列表，**不应该**立即出现新的 "New Chat" 条目。
   - 中间聊天区域应清空，显示开始界面。

3. **发送消息** ("你好")
   - 发送后，观察左侧列表，此时应该**出现**一个新的会话条目。
   - 且如果有后端 ID 同步，该条目 ID 会自动更新。

4. **再次刷新**
   - 刚才发送过消息的会话应该保留。
   - 不会再额外增加空白会话。

---

**代码已提交并编译通过。**
