# w2.6.0 前端开发计划（阶段一：核心 UX 提升）

- **版本号**：w2.6.0
- **日期**：2026-01-17
- **范围**：仅覆盖「阶段一（Immediate Wins）」
- **目标**：提升对话主流程的操作效率与反馈质量；实现低风险、高收益的体验升级。

---

## 1. 背景与目标

### 1.1 背景（现状痛点）
- 用户经常需要复制 AI 回复或代码块，目前缺少「一键复制」能力。
- 长响应/流式输出时，反馈不足（用户不确定系统是否在工作、是否卡住）。
- 错误提示偏技术或缺少统一展示（现在多靠 console / 简单提示）。
- 对话内容的「输出规模」缺少统一指标（目前已有 reasoningLength 思路，希望补齐 contentLength，并统一成 tokens 语义）。

### 1.2 目标（w2.6.0）
阶段一聚焦 5 件事：
1) **复制能力**
   - 支持复制「整条消息」
   - 支持复制「代码块」
2) **统一 Toast 通知**
   - Upload 成功/失败、复制成功、请求失败等都用统一 Toast 提示
   - 支持 `success / error / info` 三类
3) **加载与流式反馈增强**
   - 更明确的「正在思考/正在输出」状态
   - 长时间无 token 的「响应较慢提示」（soft warning，不打断）
4) **错误友好化 + 重试**
   - 将常见错误映射为更易懂文案
   - 至少支持“重试最后一次请求”
5) **tokens 指标（content tokens / reasoning tokens）**
   - 在输出区域底部显示本轮输出 tokens（按现有 reasoningLength 思路扩展）
   - 文案统一使用 `tokens`，不再用 `length`

---

## 2. 版本范围（Scope）

### 2.1 ✅ 本版本要做
- Message 层面的复制按钮（默认对 assistant 消息开启；若需要也可对 user 开启）
- Code block 复制按钮（仅 block code 展示；inline code 不加）
- Toast 组件（全局挂载一次，右下角浮层）
- Chat 请求错误统一 toast + 友好文案映射 + 重试入口
- 流式输出「thinking」提示、首 token 超时提示（例如 8s~12s 给出“响应较慢”）
- 输出 tokens 指标：
  - `content tokens`：按 stream 的 `content` 统计
  - `reasoning tokens`：按 stream 的 `reasoning` 统计（若后端提供/当前已存在）

### 2.2 ❌ 本版本不做（明确不扩 scope）
- 搜索、快捷键、暗黑模式、移动端抽屉式侧边栏（留到后续阶段）
- 权限/鉴权策略
- 复杂导出（PDF/Markdown 导出）——可作为阶段二/三
- 历史对话全量检索/跨会话管理（本阶段只做 UX 即时收益）

---

## 3. 交互设计（UI/UX 细节）

### 3.1 消息复制（Message Copy）
- **位置**：每条消息气泡右上角（hover 才显示，保持界面干净）
- **行为**：
  - 点击后复制 message 的纯文本内容（建议复制 Markdown 原文；避免丢失代码块结构）
  - 成功：Toast “已复制”
  - 失败：Toast “复制失败（浏览器权限或非 HTTPS）”
- **边界**：
  - 空内容不显示按钮
  - 流式输出过程中可复制，复制的是当前已生成部分

### 3.2 代码块复制（Code Block Copy）
- **位置**：每个代码块右上角
- **行为**：复制代码块纯文本（去掉围栏）
- **反馈**：
  - 成功 Toast “代码已复制”
  - 失败 Toast “复制失败”

### 3.3 Toast 通知
- **样式**：右下角浮层（不遮挡输入框）
- **规则**：
  - 单条 2~3 秒自动消失
  - 支持堆叠（最多 3 条），超过则覆盖最旧/或丢弃最旧（实现时二选一）
- **触发点**：
  - Upload 成功/失败
  - Message Copy / Code Copy
  - Chat 请求 error（网络错误、后端 4xx/5xx、SSE 中断）

### 3.4 加载与超时提示（流式体验）
- **现状**：InputBar 有 “正在处理...”，但主区不明显
- **增强**：
  - 若 start 后超过阈值仍无首 token：在消息区展示轻提示 “响应时间较长，请耐心等待…”
  - 一旦收到首 token 自动消失

### 3.5 tokens 指标展示（content / reasoning）
- **位置**：assistant 消息底部（或 message footer），与现有 reasoningLength 同风格
- **展示规则**：
  - 始终显示 `content tokens: N`
  - 当存在 reasoning（非空）时显示 `reasoning tokens: M`；否则该行不显示
- **计数方式（前端近似）**：
  - 阶段一不引入 tokenizer 依赖，先用“近似 tokens”策略：
    - `tokens ≈ Math.ceil(text.length / 4)`（英文近似）
    - 对包含大量中文的文本，会偏小/偏大都可接受（阶段二再引入更准确 tokenizer）

---

## 4. 技术方案（按现有代码结构落地）

### 4.1 Toast 基础设施（推荐 zustand 或 React Context）
建议做法（更贴近当前项目）：
- 新增 `store/toastStore.ts`（zustand）
  - `toasts: { id, type, message, ttlMs, actionLabel?, onAction? }[]`
  - `pushToast(type, message, options?)`
  - `removeToast(id)`
- 新增 `components/ToastHost.tsx`
  - 在 `app/layout.tsx` 或根容器挂载一次

### 4.2 MessageList 增加 Copy Button（MessageBubble 内）
- 改动点：`components/MessageBubble.tsx` 或 `components/MessageList.tsx`（以当前实际渲染点为准）
- 在 bubble 容器内加绝对定位按钮（hover 显示）
- 调用 `navigator.clipboard.writeText(message.content)`
- 捕获异常并 Toast

### 4.3 Code Block Copy（ReactMarkdown components.code / pre）
- 当前项目若已自定义 `pre/code` 渲染：
  - 对 block code：在 `pre` 外包一层 `relative` 容器
  - 右上角放 Copy 按钮
  - 提取 children 文本并复制
- 注意：
  - inline code 不加按钮
  - 不破坏现有 Markdown/GFM/KaTeX 渲染

### 4.4 Chat 错误友好化（含重试）
- 改动点：`components/ChatContainer.tsx`（或实际发送/stream 管理文件）
- 错误映射建议：
  - `TypeError: Failed to fetch` / 网络错误 -> “网络连接失败，请检查后端或网络”
  - `HTTP 5xx` -> “服务端异常（可稍后重试）”
  - SSE 中断/流式异常 -> “连接中断（可重试）”
- 重试策略：
  - 缓存 last request payload（最后一次 user input + session/conversation 参数）
  - Toast 提供 action：`重试`

### 4.5 tokens 指标（content tokens / reasoning tokens）
- 改动点：
  - 消息渲染组件（assistant 消消息底部加 footer）
  - stream 更新逻辑：在接收 token chunk 时同步累积 `contentText` / `reasoningText`
- 工具函数：
  - `lib/tokenEstimate.ts`：提供 `estimateTokens(text)`

---

## 5. 具体步骤（Task Breakdown）

1) **Toast Store + ToastHost**
   - 新增 toast store（push/remove/ttl）
   - 新增 ToastHost 并全局挂载
2) **Upload 接入 Toast**
   - Upload 成功/失败统一 Toast
   - 保留原有状态展示（如有），避免破坏现有流程
3) **Message Copy**
   - assistant 消息 hover 显示复制按钮
   - 复制成功/失败 Toast
4) **Code Block Copy**
   - block code 右上角复制按钮
   - 复制成功/失败 Toast
5) **统一错误捕获 + 友好文案 + 重试入口**
   - 捕获 fetch/SSE 失败
   - Toast 显示可读错误
   - 允许一键重试最后一次请求
6) **tokens 指标（content / reasoning）**
   - 将现有 `reasoningLength` 语义改为 `reasoningTokens`
   - 新增 `contentTokens`
   - UI 文案统一为 tokens

---

## 6. 里程碑与排期（建议）

- **M1（0.5d）**：Toast 基础设施 + 全局挂载
- **M2（0.5d）**：Upload/Copy 接入 Toast（含基础样式）
- **M3（0.5d）**：Chat 错误友好化 + 重试
- **M4（0.5d）**：流式慢响应提示 + tokens 指标接入

> 备注：排期按“单前端工程师”估算；若已有组件基础（例如已有 store/统一错误处理），可压缩。

---

## 7. 验收标准（DoD）

- 任意一条 assistant 消息可一键复制，Toast 提示出现
- 任意一个代码块可一键复制，复制内容正确
- Upload 成功/失败使用 Toast 展示（且不阻塞 UI）
- Chat 请求失败能出现友好错误 Toast
- 至少支持“重试最后一次请求”
- 输出区域能显示 `content tokens`；存在 reasoning 时显示 `reasoning tokens`
- 不影响现有滚动、Reasoning Drawer、Session 逻辑
- `pnpm run build` 通过

---

## 8. 风险与注意事项

- Clipboard API 在部分浏览器/非 HTTPS 环境可能失败，需要捕获异常并 Toast 提示
- 流式输出中频繁 re-render，要避免 ToastHost 触发整页重绘（store 粒度要小）
- tokens 为近似估算；后续若要精确，可引入 tokenizer（阶段二）
- Copy 按钮 hover 展示，注意移动端（后续阶段再做移动端适配）
